<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real-Time Private Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@3.1.8/dist/browser/signalr.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .chat-container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .chat-header {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

            .chat-header input {
                flex: 1;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 8px;
            }

        #chatBox {
            border: 1px solid #ddd;
            padding: 10px;
            height: 350px;
            overflow-y: auto;
            background: #fafafa;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .message {
            padding: 10px 14px;
            margin: 6px 0;
            border-radius: 10px;
            max-width: 70%;
            clear: both;
            word-wrap: break-word;
        }

        .sent {
            background-color: #dcf8c6;
            float: right;
            text-align: right;
        }

        .received {
            background-color: #f1f0f0;
            float: left;
            text-align: left;
        }

        .chat-footer {
            display: flex;
            gap: 10px;
        }

            .chat-footer input {
                flex: 1;
                padding: 10px 14px;
                border: 1px solid #ddd;
                border-radius: 8px;
            }

            .chat-footer button {
                background-color: #4caf50;
                color: white;
                border: none;
                padding: 10px 18px;
                border-radius: 8px;
                cursor: pointer;
            }

                .chat-footer button:hover {
                    background-color: #45a049;
                }
    </style>
</head>
<body>

    <div class="chat-container">
        <h2>SignalR Private Chat</h2>

        <div class="chat-header">
            <input type="text" id="myId" placeholder="Your ID" />
            <input type="text" id="receiverId" placeholder="Receiver ID" />
            <button onclick="connect()">Connect</button>
        </div>

        <div id="chatBox"></div>

        <div class="chat-footer">
            <input type="text" id="messageInput" placeholder="Type message..." />
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let connection;

        function connect() {
            const myId = document.getElementById("myId").value;
            if (!myId) return alert("Enter your ID first!");

            connection = new signalR.HubConnectionBuilder()
                .withUrl(`/chatHub?userId=${myId}`)
                .build();

            connection.on("ReceiveMessages", (messages) => {
                const chatBox = document.getElementById("chatBox");
                const myUserId = document.getElementById("myId").value;
                messages.forEach(msg => {
                    appendMessage(msg.senderId, msg.content, myUserId);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            connection.on("ReceiveMessage", (senderId, content) => {
                const myUserId = document.getElementById("myId").value;
                appendMessage(senderId, content, myUserId);
            });

            connection.start()
                .then(() => {
                    alert("Connected as " + myId);
                    const receiverId = document.getElementById("receiverId").value;
                    if (receiverId) {
                        connection.invoke("GetMessages", myId, receiverId)
                            .catch(err => console.error("Error fetching messages:", err));
                    }
                })
                .catch(err => console.error("Error connecting:", err));
        }

        function sendMessage() {
            const myId = document.getElementById("myId").value;
            const receiverId = document.getElementById("receiverId").value;
            const messageContent = document.getElementById("messageInput").value;

            if (!myId || !receiverId || !messageContent) {
                return alert("Please fill in your ID, receiver's ID and message!");
            }

            // Call API instead of SignalR directly to send the message
            fetch("/api/Chat/send", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    senderId: myId,
                    receiverId: receiverId,
                    content: messageContent
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to send message.");
                    }
                    // If message sent successfully, clear the input
                    document.getElementById("messageInput").value = '';
                })
                .catch(err => {
                    console.error("Error sending message:", err);
                });
        }

        function appendMessage(senderId, content, myUserId) {
            const chatBox = document.getElementById("chatBox");
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message");
            messageDiv.classList.add(senderId === myUserId ? "sent" : "received");
            messageDiv.innerHTML = `<strong>${senderId}:</strong> ${content}`;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>

</body>
</html>
